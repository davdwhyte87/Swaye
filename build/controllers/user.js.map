{"version":3,"sources":["../../controllers/user.js"],"names":["User","require","bcrypt","mongoose","jwt","exports","sayhi","req","res","status","json","message","signup","check","isString","exists","isLength","min","errors","validationErrors","code","find","phone","body","email","exec","then","user","length","hash","password","err","error","_id","Types","ObjectId","name","Math","floor","random","save","sgMail","setApiKey","process","env","SMS_KEY","msg","to","from","subject","html","send","console","log","result","data","catch","signin","findOne","compare","token","sign","userId","type","JWT","expiresIn","confirm","confirmed","forgot_pass","fchange_pass","new_password","user_id","userData","select"],"mappings":"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","file":"user.js","sourcesContent":["const User=require('../models/User')\r\nconst bcrypt=require('bcrypt')\r\nconst mongoose=require('mongoose')\r\nconst jwt=require('jsonwebtoken')\r\n\r\n\r\n//test\r\nexports.sayhi=(req,res)=>{\r\n    res.status(200).json({message:\"how far\"})\r\n}\r\n\r\n\r\n//sign up function\r\nexports.signup=(req,res)=>{\r\n    req.check(\"name\",\"Name is required\").isString().exists()\r\n    req.check(\"email\",\"You need a valid email\").isLength({min:8}).exists()\r\n    var errors=req.validationErrors()\r\n    if(errors){\r\n        return res.status(200).json({code:0,message:\"An error occured\",errors:errors})\r\n    }    \r\n    //check if a user exists\r\n    User.find({phone:req.body.email}).exec().then(user=>{\r\n        if(user.length>0){\r\n            return res.status(200).json({code:0,message:\"This user already exists.\"})\r\n        }else{\r\n            bcrypt.hash(req.body.password,10,(err,hash)=>{\r\n                if(err){\r\n                    return res.status(500)\r\n                    .json({code:0,error:err,message:\"An error occurred\"})\r\n                }\r\n                else{\r\n                    var user=new User({\r\n                        _id:new mongoose.Types.ObjectId(),\r\n                        name:req.body.name,\r\n                        email:req.body.email,\r\n                        password:hash,\r\n                        code:Math.floor(Math.random()*90000) + 10000\r\n                    })\r\n                    user.save().then(result=>{\r\n                        //send user a mail\r\n                        const sgMail = require('@sendgrid/mail')\r\n                        sgMail.setApiKey(process.env.SMS_KEY)\r\n                        const msg = {\r\n                        to: user.email,\r\n                        from: 'swaye407@gmail.com',\r\n                        subject: 'Swaye Confirmation code',\r\n                        html: '<p>Thank you for using swaye, here is your code:'+user.code+'</p>',\r\n                        }\r\n                        sgMail.send(msg)\r\n                        console.log(result)\r\n                        res.status(200).json({code:1,message:\"User created successfully\",data:user})\r\n                    })\r\n                    .catch(error=>{\r\n                        console.log(error)\r\n                        return res.status(500).json({error:error})\r\n                    })\r\n                }\r\n            })\r\n        }\r\n    })\r\n}\r\n\r\n//sign in a user\r\nexports.signin=(req,res)=>{\r\n    //validate data\r\n    req.check(\"email\",\"You need a valid email\").isLength({min:8}).exists()\r\n    var errors=req.validationErrors()\r\n    if(errors){\r\n        return res.status(200).json({code:0,message:\"An error occured\",errors:errors})\r\n    }  \r\n    //get the user by phone data\r\n    User.findOne({email:req.body.email})\r\n    .exec().then(user=>{\r\n        if(!user){\r\n            return res.status(200).json({code:0,message:\"This account does not exist\"})\r\n        }else{\r\n            //check the password\r\n            bcrypt.compare(req.body.password,user.password,(err,result)=>{\r\n                if(err){\r\n                    return res.status(404).json({code:0,message:\"An error occurred\"})\r\n                }\r\n                if(result){\r\n                    //create token\r\n                    const token=jwt.sign({email:user.email,userId:user._id,type:\"user\"},process.env.JWT,{\r\n                        expiresIn:\"1h\"\r\n                    })\r\n                    return res.status(200).json({code:1,message:\"Signin successfull\",token:token,data:user}) \r\n                }\r\n                else{\r\n                    return res.status(200).json({code:0,message:\"Authentication failed\"})\r\n                }\r\n            })\r\n        }\r\n    })\r\n    .catch(error=>{\r\n        console.log(error)\r\n        return res.status(500).json({code:0,message:\"An error occurred\"})\r\n    })\r\n}\r\n\r\n\r\n//confirms a user account with a code\r\nexports.confirm=(req,res)=>{\r\n    req.check(\"code\",\"You need the code\").exists()\r\n    var errors=req.validationErrors()\r\n    if(errors){\r\n        return res.status(200).json({code:0,message:\"An error occured\",errors:errors})\r\n    } \r\n    User.findOne({code:req.body.code}).exec()\r\n    .then(user=>{\r\n        if(user){\r\n            user.confirmed=true\r\n            user.save().then(result=>{\r\n                console.log(result)\r\n                res.status(200).json({code:1,message:\"Your account has been confirmed\"})\r\n            })\r\n            .catch(error=>{\r\n                console.log(error)\r\n                res.status(500).json({error:error,code:0,message:\"An error occurred\"})\r\n            })\r\n        }else{\r\n            res.status(200).json({code:0,message:\"This code does not exist\"}) \r\n        }\r\n    })\r\n    .catch(error=>{\r\n        console.log(error)\r\n        return res.status(500).json({error:error})\r\n    })\r\n}\r\n\r\nexports.forgot_pass=(req,res)=>{\r\n    User.findOne({email:req.body.email}).exec()\r\n    .then(user=>{\r\n        if(user){\r\n            user.code=Math.floor(Math.random()*90000) + 10000\r\n            user.save().then(result=>{\r\n                const sgMail = require('@sendgrid/mail')\r\n                sgMail.setApiKey(process.env.SMS_KEY)\r\n                const msg = {\r\n                to: user.email,\r\n                from: 'swaye407@gmail.com',\r\n                subject: 'Swaye Confirmation code',\r\n                html: '<p>Thank you for using swaye, here is your code:'+user.code+'</p>',\r\n                }\r\n                sgMail.send(msg)\r\n                console.log(result)\r\n                return res.status(200).json({code:1,message:\"A meail has been sent with your code\",data:result})\r\n            })\r\n            .catch(error=>{\r\n                console.log(error)\r\n                return res.status(500).json({code:0,message:\"An error occured\"})\r\n            })\r\n        }\r\n        else{\r\n            return res.status(200).json({code:0,message:\"This email does not exist\"})\r\n        }\r\n    })\r\n    .catch(error=>{\r\n        return res.status(500).json({code:0,message:\"An error occured\",error:error})\r\n    })\r\n}\r\n\r\nexports.fchange_pass=(req,res)=>{\r\n    //validate req data\r\n    req.check(\"code\",\"Name is required\").isString().exists()\r\n    req.check(\"new_password\",\"A password is required\").exists()\r\n    var errors=req.validationErrors()\r\n    if(errors){\r\n        return res.status(200).json({code:0,message:\"An error occured\",errors:errors})\r\n    }  \r\n    User.findOne({code:req.body.code}).exec()\r\n    .then(user=>{\r\n        if(user){\r\n            bcrypt.hash(req.body.new_password,10,(err,hash)=>{\r\n                if(err){\r\n                    return res.status(500).json({error:err,code:0})\r\n                }\r\n                user.password=hash\r\n                user.save().then(result=>{\r\n                    console.log(result)\r\n                    return res.status(200).json({code:1,message:\"Your password has been changed\"})\r\n                })\r\n                .catch(error=>{\r\n                    console.log(error)\r\n                    return res.status(500).json({code:0,error:error,message:\"An error occurred\"})\r\n                })\r\n            })\r\n        }\r\n        else{\r\n            return res.status(200).json({code:0,message:\"Wrong code!\"}) \r\n        }\r\n    })\r\n    .catch(error=>{\r\n        console.log(error)\r\n        return res.status(500).json({code:0,error:error,message:\"An error occurred\"}) \r\n    })\r\n}\r\n\r\n//get a signed in user\r\n//protected function\r\nexports.user=(req,res)=>{\r\n    var user_id=req.userData.userId\r\n    User.findOne({_id:user_id})\r\n    .select(\"name email phone\")\r\n    .exec()\r\n    .then(user=>{\r\n        if(user){\r\n            return res.status(200).json({code:1,data:user})\r\n        }\r\n        else{\r\n            return res.status(200).json({code:0,message:\"This account does not exist\"})\r\n        }\r\n    })\r\n    .catch(error=>{\r\n        return res.status(500).json({code:0,error:error})\r\n    })\r\n}"]}