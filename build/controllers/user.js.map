{"version":3,"sources":["../../controllers/user.js"],"names":["User","require","bcrypt","mongoose","jwt","exports","sayhi","req","res","status","json","message","signup","find","email","body","exec","then","user","length","code","hash","password","err","error","_id","Types","ObjectId","name","Math","floor","random","save","console","log","result","data","catch","signin","findOne","compare","token","sign","userId","type","process","env","JWT","expiresIn","confirm","confirmed","forgot_pass","fchange_pass","new_password","user_id","userData","select"],"mappings":"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","file":"user.js","sourcesContent":["const User=require('../models/User')\r\nconst bcrypt=require('bcrypt')\r\nconst mongoose=require('mongoose')\r\nconst jwt=require('jsonwebtoken')\r\n//test\r\nexports.sayhi=(req,res)=>{\r\n    res.status(200).json({message:\"how far\"})\r\n}\r\n\r\n//sign up function\r\nexports.signup=(req,res)=>{\r\n    User.find({email:req.body.email}).exec().then(user=>{\r\n        if(user.length>0){\r\n            return res.status(409).json({code:0,message:\"This user already exists.\"})\r\n        }else{\r\n            bcrypt.hash(req.body.password,10,(err,hash)=>{\r\n                if(err){\r\n                    return res.status(500)\r\n                    .json({code:0,error:err,message:\"An error occurred\"})\r\n                }\r\n                else{\r\n                    var user=new User({\r\n                        _id:new mongoose.Types.ObjectId(),\r\n                        name:req.body.name,\r\n                        email:req.body.email,\r\n                        password:hash,\r\n                        code:Math.floor(Math.random()*90000) + 10000\r\n                    })\r\n                    user.save().then(result=>{\r\n                        //send user a mail\r\n                        console.log(result)\r\n                        res.status(200).json({code:1,message:\"User created successfully\",data:user})\r\n                    })\r\n                    .catch(error=>{\r\n                        console.log(error)\r\n                        return res.status(500).json({error:error})\r\n                    })\r\n                }\r\n            })\r\n        }\r\n    })\r\n}\r\n\r\n//sign in a user\r\nexports.signin=(req,res)=>{\r\n    User.findOne({email:req.body.email})\r\n    .exec().then(user=>{\r\n        if(!user){\r\n            return res.status(200).json({code:0,message:\"This account does not exist\"})\r\n        }else{\r\n            bcrypt.compare(req.body.password,user.password,(err,result)=>{\r\n                if(err){\r\n                    return res.status(404).json({code:0,message:\"An error occurred\"})\r\n                }\r\n                if(result){\r\n                    const token=jwt.sign({email:user.email,userId:user._id,type:\"user\"},process.env.JWT,{\r\n                        expiresIn:\"1h\"\r\n                    })\r\n                    return res.status(200).json({code:1,message:\"Signin successfull\",token:token}) \r\n                }\r\n                else{\r\n                    return res.status(200).json({code:0,message:\"Authentication failed\"})\r\n                }\r\n            })\r\n        }\r\n    })\r\n    .catch(error=>{\r\n        console.log(error)\r\n        return res.status(500).json({code:0,message:\"An error occurred\"})\r\n    })\r\n}\r\n\r\n\r\n//confirms a user account with a code\r\nexports.confirm=(req,res)=>{\r\n    User.findOne({code:req.body.code}).exec()\r\n    .then(user=>{\r\n        if(user){\r\n            user.confirmed=true\r\n            user.save().then(result=>{\r\n                console.log(result)\r\n                res.status(200).json({code:1,message:\"Your account has been confirmed\"})\r\n            })\r\n            .catch(error=>{\r\n                console.log(error)\r\n                res.status(500).json({error:error,code:0,message:\"An error occurred\"})\r\n            })\r\n        }else{\r\n            res.status(200).json({code:0,message:\"This code does not exist\"}) \r\n        }\r\n    })\r\n    .catch(error=>{\r\n        console.log(error)\r\n        return res.status(500).json({error:error})\r\n    })\r\n}\r\n\r\nexports.forgot_pass=(req,res)=>{\r\n    User.findOne({email:req.body.email}).exec()\r\n    .then(user=>{\r\n        if(user){\r\n            user.code=Math.floor(Math.random()*90000) + 10000\r\n            user.save().then(result=>{\r\n                console.log(result)\r\n                return res.status(200).json({code:1,message:\"A meail has been sent with your code\"})\r\n            })\r\n            .catch(error=>{\r\n                console.log(error)\r\n                return res.status(500).json({code:0,message:\"An error occured\"})\r\n            })\r\n        }\r\n        else{\r\n            return res.status(200).json({code:0,message:\"This email does not exist\"})\r\n        }\r\n    })\r\n    .catch(error=>{\r\n        return res.status(500).json({code:0,message:\"An error occured\",error:error})\r\n    })\r\n}\r\n\r\nexports.fchange_pass=(req,res)=>{\r\n    User.findOne({code:req.body.code}).exec()\r\n    .then(user=>{\r\n        if(user){\r\n            bcrypt.hash(req.body.new_password,10,(err,hash)=>{\r\n                if(err){\r\n                    return res.status(500).json({error:err,code:0})\r\n                }\r\n                user.password=hash\r\n                user.save().then(result=>{\r\n                    console.log(result)\r\n                    return res.status(200).json({code:1,message:\"Your password has been changed\"})\r\n                })\r\n                .catch(error=>{\r\n                    console.log(error)\r\n                    return res.status(500).json({code:0,error:error,message:\"An error occurred\"})\r\n                })\r\n            })\r\n        }\r\n    })\r\n    .catch(error=>{\r\n        console.log(error)\r\n        return res.status(500).json({code:0,error:error,message:\"An error occurred\"}) \r\n    })\r\n}\r\n\r\n//get a signed in user\r\n//protected function\r\nexports.user=(req,res)=>{\r\n    var user_id=req.userData.userId\r\n    User.findOne({_id:user_id})\r\n    .select(\"name email phone\")\r\n    .exec()\r\n    .then(user=>{\r\n        if(user){\r\n            return res.status(200).json({code:1,data:user})\r\n        }\r\n        else{\r\n            return res.status(200).json({code:0,message:\"This account does not exist\"})\r\n        }\r\n    })\r\n    .catch(error=>{\r\n        return res.status(500).json({code:0,error:error})\r\n    })\r\n}"]}